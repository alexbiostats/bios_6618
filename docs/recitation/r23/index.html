<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Kaizer">

<title>Alex Kaizer - Splines in Linear Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/academicons-1.9.1/css/academicons.css" rel="stylesheet">

<link rel="icon" type="image/png" href="./files/favicon.ico">

<script type="text/javascript">
function setBrand() {
document.getElementsByClassName("navbar-brand")[0].href="https://www.alexkaizer.com";
}
window.onload = setBrand;
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5PBG7BL207"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5PBG7BL207');
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Alex Kaizer</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://www.alexkaizer.com/research" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.alexkaizer.com/publications" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-teaching" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Teaching</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-teaching">    
        <li>
    <a class="dropdown-item" href="https://www.alexkaizer.com/teaching" rel="" target="">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.alexkaizer.com/bios_6618" rel="" target="">
 <span class="dropdown-text">BIOS 6618</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.alexkaizer.com/bios_6611" rel="" target="">
 <span class="dropdown-text">BIOS 6611</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.alexkaizer.com/study_design_berd" rel="" target="">
 <span class="dropdown-text">BERD Study Design Short Course</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.alexkaizer.com/adaptivetrials_sc" rel="" target="">
 <span class="dropdown-text">WNAR Adaptive and Bayesian Clinical Trial Design Short Course</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bios-6618" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">BIOS 6618</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bios-6618">    
        <li>
    <a class="dropdown-item" href="../../index.html" rel="" target="">
 <span class="dropdown-text">Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../bios_6618_materials" rel="" target="">
 <span class="dropdown-text">Materials</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../journal_of_bios_6618" rel="" target="">
 <span class="dropdown-text">Journal of BIOS 6618</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../recitation" rel="" target="">
 <span class="dropdown-text">Recitation Questions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs" rel="" target="">
 <span class="dropdown-text">Labs and Practice Problems</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:alex.kaizer@cuanschutz.edu" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=ICpH74EAAAAJ&amp;hl=en" rel="" target="">
 <span class="menu-text"><i class="ai  ai-google-scholar ai-large"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="http://github.com/alexbiostats" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.alexkaizer.com/files/Alex_CV.pdf" rel="" target="">
 <span class="menu-text"><i class="ai  ai-cv ai-large"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/alex-kaizer/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#splines" id="toc-splines" class="nav-link active" data-scroll-target="#splines">Splines</a>
  <ul class="collapse">
  <li><a href="#why-extra-knots" id="toc-why-extra-knots" class="nav-link" data-scroll-target="#why-extra-knots">Why Extra Knots?</a></li>
  <li><a href="#selecting-optimal-parameters" id="toc-selecting-optimal-parameters" class="nav-link" data-scroll-target="#selecting-optimal-parameters">Selecting Optimal Parameters</a></li>
  <li><a href="#model-interpretation-with-splines" id="toc-model-interpretation-with-splines" class="nav-link" data-scroll-target="#model-interpretation-with-splines">Model Interpretation with Splines</a>
  <ul class="collapse">
  <li><a href="#mlr-with-sex-and-age" id="toc-mlr-with-sex-and-age" class="nav-link" data-scroll-target="#mlr-with-sex-and-age">MLR with Sex and Age</a></li>
  <li><a href="#sex-and-age-with-natural-cubic-spline" id="toc-sex-and-age-with-natural-cubic-spline" class="nav-link" data-scroll-target="#sex-and-age-with-natural-cubic-spline">Sex and Age with Natural Cubic Spline</a></li>
  <li><a href="#sex-and-age-with-natural-cubic-spline-and-their-interaction" id="toc-sex-and-age-with-natural-cubic-spline-and-their-interaction" class="nav-link" data-scroll-target="#sex-and-age-with-natural-cubic-spline-and-their-interaction">Sex and Age with Natural Cubic Spline and Their Interaction</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Splines in Linear Regression</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Alex Kaizer </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Colorado-Anschutz Medical Campus
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<p>This page is part of the University of Colorado-Anschutz Medical Campus’ <a href="../../recitation/index.html">BIOS 6618 Recitation</a> collection. To view other questions, you can view the <a href="../../recitation/index.html">BIOS 6618 Recitation</a> collection page or use the search bar to look for keywords.</p>
<section id="splines" class="level1">
<h1>Splines</h1>
<section id="why-extra-knots" class="level2">
<h2 class="anchored" data-anchor-id="why-extra-knots">Why Extra Knots?</h2>
<p>In our lecture slides we noted:</p>
<p>The B-spline basis is a common spline basis and can be fit in <code>R</code> using the <code>splines::bs()</code> function.</p>
<p>The B-spline basis is based on the knot sequence: <span class="math display">\[\begin{align*}
\xi_1 \leq \cdots &amp;  \leq \xi_d \leq \color{red}{\xi_{d+1}} &lt; \color{blue}{\xi_{d+2}} &lt; \cdots \color{blue}{\xi_{d+K+1}} \\
&amp; &lt; \color{red}{\xi_{d+K+2}} \leq \xi_{d+K+3} \leq \cdots \leq \xi_{2d+K+2}
\end{align*}\]</span></p>
<p>The “inner knots” are represented by <span class="math inline">\(\color{blue}{\xi_{d+2}} = \tau_1, \cdots, \color{blue}{\xi_{d+K+1}}=\tau_K\)</span>.</p>
<p>The “boundary knots” are defined as <span class="math inline">\(\color{red}{\xi_{d+1}}=a\)</span> and <span class="math inline">\(\color{red}{\xi_{d+K+2}}=b\)</span>.</p>
<p>The choice of additional knots <span class="math inline">\(\xi_1, \cdots, \xi_d\)</span> and <span class="math inline">\(\xi_{d+K+3}, \cdots, \xi_{2d+K+2}\)</span> is somewhat arbitrary, with a common strategy being to set them equal to the boundary knots.</p>
<p>The reason we set these additional knots before and after the boundary knots (even if we set them to be identical) is to assist in defining appropriate basis functions for each segment of our data (i.e., between any two knots). This could be thought of as a mathematical trick to ensure certain properties of the B-spline are maintained, but the specific mathematical details go beyond the material for our class.</p>
</section>
<section id="selecting-optimal-parameters" class="level2">
<h2 class="anchored" data-anchor-id="selecting-optimal-parameters">Selecting Optimal Parameters</h2>
<p>In our lecture we also mentioned approaches to selecting optimal spline parameters:</p>
<ul>
<li>Use of visual evaluation (e.g., seeing that the data does not appear to be overfit)</li>
<li>Model selection criterion (e.g., AIC, AICc, BIC, etc.) to compare models with different parameters (minimized AIC is preferred)</li>
<li>Cross validation (CV) by dividing the <span class="math inline">\(N\)</span> data points into <span class="math inline">\(K\)</span> groups/folds for train/test set evaluation</li>
</ul>
<p>We’ve seen examples of visual evaluation already, so we’ll explore some approaches using model selection criteria. Let’s revisit our NHANES data example focusing on modeling testosterone in males:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'../../.data/nhanes1516_sexhormone.csv'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>datm <span class="ot">&lt;-</span> dat[<span class="fu">which</span>(dat<span class="sc">$</span>MALE<span class="sc">==</span><span class="cn">TRUE</span>),] <span class="co"># subset to males</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We again see a clearly non-linear trend for age and testosterone. Let’s fit a range of models with different degrees of freedom (3, 4, and 5) using B-splines and natural cubic splines:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty lists to store results in</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>bs_list <span class="ot">&lt;-</span> ns_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through degrees of freedom of 3 to 15 and save model</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( df <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">15</span> ){</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  bs_list[[(df<span class="dv">-2</span>)]] <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">bs</span>(RIDAGEYR, <span class="at">df=</span>df), <span class="at">data=</span>datm)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  ns_list[[(df<span class="dv">-2</span>)]] <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR, <span class="at">df=</span>df), <span class="at">data=</span>datm)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s plot some of these trends:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>newdatm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">80</span> )</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">1</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># df=3</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=3'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">1</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">1</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># df=6</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=6'</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">4</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">4</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># df=8</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=8'</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">6</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">6</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># df=9</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=9'</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">7</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">7</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Visually evaluating the figures, we might think df=3 looks pretty decent (expect, perhaps, at the younger ages). The fit at lower ages is improved as we increase the degrees of freedom. We also might wish to compare the B-spline and the natural cubic splines within any degree of freedom.</p>
<p>One approach is to use model selection criteria. Let’s examine a table and plot of our values for AIC and BIC:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate AIC</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>aic_bs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">AIC</span>(bs_list[[x]]))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>aic_ns <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">AIC</span>(ns_list[[x]]))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate BIC</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>bic_bs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">BIC</span>(bs_list[[x]]))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>bic_ns <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">BIC</span>(ns_list[[x]]))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># table of values</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">cbind</span>(aic_bs,aic_ns,bic_bs,bic_ns)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tbl) <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>tbl <span class="co"># print</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     aic_bs   aic_ns   bic_bs   bic_ns
3  47127.87 47050.22 47158.71 47081.05
4  46835.47 46782.66 46872.48 46819.66
5  46908.45 46808.94 46951.62 46852.11
6  46719.40 46773.75 46768.74 46823.09
7  46648.94 46675.38 46704.44 46730.89
8  46678.38 46640.07 46740.05 46701.74
9  46657.13 46630.35 46724.97 46698.19
10 46644.05 46640.55 46718.06 46714.55
11 46632.50 46640.48 46712.67 46720.65
12 46637.82 46643.75 46724.16 46730.09
13 46637.86 46631.73 46730.37 46724.24
14 46643.69 46632.61 46742.36 46731.29
15 46633.49 46634.43 46738.33 46739.27</code></pre>
</div>
</div>
<p>There is a lot going on here. To help us identify the “best” model using AIC or BIC, let’s take the minimum AIC or BIC observed across both B-splines and natural cubic splines and compare:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> tbl <span class="sc">-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">min</span>(tbl[,<span class="fu">c</span>(<span class="st">'aic_bs'</span>,<span class="st">'aic_ns'</span>)]),<span class="fu">min</span>(tbl[,<span class="fu">c</span>(<span class="st">'bic_bs'</span>,<span class="st">'bic_ns'</span>)])), <span class="at">each=</span><span class="fu">nrow</span>(tbl)<span class="sc">*</span><span class="dv">2</span>), <span class="at">ncol=</span><span class="dv">4</span>, <span class="at">byrow=</span>F)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(diff,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   aic_bs aic_ns bic_bs bic_ns
3   497.5  419.9  460.5  382.9
4   205.1  152.3  174.3  121.5
5   278.1  178.6  253.4  153.9
6    89.0  143.4   70.5  124.9
7    18.6   45.0    6.3   32.7
8    48.0    9.7   41.9    3.6
9    26.8    0.0   26.8    0.0
10   13.7   10.2   19.9   16.4
11    2.1   10.1   14.5   22.5
12    7.5   13.4   26.0   31.9
13    7.5    1.4   32.2   26.0
14   13.3    2.3   44.2   33.1
15    3.1    4.1   40.1   41.1</code></pre>
</div>
</div>
<p>With these results and a rule of thumb of decreases in AIC or BIC greater than 4, we notice:</p>
<ul>
<li>For AIC, the natural cubic spline model with df=9 minimizes the AIC. Models within 4 of this include:
<ul>
<li>df=11 B-spline (<span class="math inline">\(\Delta=2.1\)</span>)</li>
<li>df=15 B-spline (<span class="math inline">\(\Delta=3.1\)</span>)</li>
<li>df=13 natural cubic spline (<span class="math inline">\(\Delta=1.4\)</span>)</li>
<li>df=14 natural cubic spline (<span class="math inline">\(\Delta=2.3\)</span>)</li>
<li>However, all these models have higher degrees of freedom and are less parsimonious.</li>
</ul></li>
<li>For BIC, the natural cubic spline model with df=9 minimizes the BIC. Models within 4 of this include:
<ul>
<li>df=8 natural cubic spline (<span class="math inline">\(\Delta=3.6\)</span>)</li>
<li>Since df=8 has fewer degrees of freedom, could select it instead of df=9 because it is slightly more parsimonious</li>
</ul></li>
</ul>
<p>However, it may also be useful to visualize if there is a point where we might start to experience “diminishing returns” for increasing our model complexity (and risking overfitting the data). Here we can plot the AIC and BIC for each method and degree of freedom:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of values</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>aic_bs, <span class="at">xlab=</span><span class="st">'df'</span>, <span class="at">ylab=</span><span class="st">'AIC/BIC Value'</span>, <span class="at">type=</span><span class="st">'o'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(aic_bs,aic_ns,bic_bs,bic_ns)))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>aic_ns, <span class="at">pch=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>bic_bs, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'orangered2'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>bic_ns, <span class="at">pch=</span><span class="dv">17</span>, <span class="at">lty=</span><span class="dv">4</span>, <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">16</span>,<span class="dv">17</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'blue'</span>,<span class="st">'orangered2'</span>,<span class="st">'purple'</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'AIC bs'</span>,<span class="st">'AIC ns'</span>,<span class="st">'BIC bs'</span>,<span class="st">'BIC ns'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Some takeaways here:</p>
<ul>
<li>Around df=7 we stop seeing larger changes (there is still some moving around, e.g., B-splines do increase from df=7 to 8 before decreasing again). So, we might consider choosing df=7 even though it wasn’t “optimal” based on the change in AIC or BIC from above.</li>
<li>We can see that BIC (solid points) is larger than the AIC (open points) values, where both natural cubic splines and B-splines seem to converge to very similar results at larger degrees of freedom.</li>
<li>In practice there are many ways we could justify the choice of different splines, degrees of freedom, or choice across other models.</li>
</ul>
</section>
<section id="model-interpretation-with-splines" class="level2">
<h2 class="anchored" data-anchor-id="model-interpretation-with-splines">Model Interpretation with Splines</h2>
<p>We’ve discussed the challenges of interpreting polynomial and spline models when our primary explanatory variable of interest is the one with the nonlinear trend. Here we will explore a model with both sex and age to see how interpretations may be affected.</p>
<section id="mlr-with-sex-and-age" class="level3">
<h3 class="anchored" data-anchor-id="mlr-with-sex-and-age">MLR with Sex and Age</h3>
<p>Let’s revisit our NHANES data example focusing on modeling testosterone, but this time in males and females and plot one multiple linear regression model with sex and age:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'../../.data/nhanes1516_sexhormone.csv'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> RIDAGEYR <span class="sc">+</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = TESTOSTERONE ~ RIDAGEYR + MALE, data = dat)

Residuals:
    Min      1Q  Median      3Q     Max 
-414.52  -51.93   -1.23   36.92 1638.21 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -30.34926    4.20501  -7.217 5.84e-13 ***
RIDAGEYR      1.36133    0.08384  16.237  &lt; 2e-16 ***
MALETRUE    337.68353    3.79058  89.085  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 160.9 on 7204 degrees of freedom
  (814 observations deleted due to missingness)
Multiple R-squared:  0.5318,    Adjusted R-squared:  0.5316 
F-statistic:  4091 on 2 and 7204 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>The interpretations of our beta coefficients here are easy to interpret:</p>
<ul>
<li>Age: For a 1 year increase in age, testosterone increases by an average of 1.36 ng/dL after adjusting for sex.</li>
<li>Sex: Testosterone is an average of 337.68 ng/dL higher in males than females after adjusting for age.</li>
</ul>
<p>We can visualize, however, that this isn’t likely the best fit:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create variable to change point type by sex</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>pch <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>pch[<span class="fu">which</span>(dat<span class="sc">$</span>MALE<span class="sc">==</span><span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>newdat_male <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">MALE=</span><span class="cn">TRUE</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>newdat_female <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">MALE=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod1, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod1, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Indeed, the fits are in both groups do not appear to be accurately reflecting the trend with age. Let’s try fitting a model with a natural cubic spline used for age next.</p>
</section>
<section id="sex-and-age-with-natural-cubic-spline" class="level3">
<h3 class="anchored" data-anchor-id="sex-and-age-with-natural-cubic-spline">Sex and Age with Natural Cubic Spline</h3>
<p>Here we will add a natural cubic spline to age with a degree of freedom of 8 (based on our other question evaluating spline calibration):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR,<span class="at">df=</span><span class="dv">8</span>) <span class="sc">+</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = TESTOSTERONE ~ ns(RIDAGEYR, df = 8) + MALE, data = dat)

Residuals:
    Min      1Q  Median      3Q     Max 
-395.19  -64.77  -26.38   51.29 1610.36 

Coefficients:
                      Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           -168.282      8.954  -18.79   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)1  356.634     12.141   29.38   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)2  218.216     15.274   14.29   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)3  232.027     13.689   16.95   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)4  202.993     14.118   14.38   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)5  225.764     13.394   16.86   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)6  203.791     11.424   17.84   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)7  192.410     21.816    8.82   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)8  194.185      8.674   22.39   &lt;2e-16 ***
MALETRUE               339.050      3.428   98.91   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 145.3 on 7197 degrees of freedom
  (814 observations deleted due to missingness)
Multiple R-squared:  0.6183,    Adjusted R-squared:  0.6178 
F-statistic:  1295 on 9 and 7197 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>The interpretations of our sex coefficient is still easy to interpret, but age not so much:</p>
<ul>
<li>Age: Given the splines, the rate of change in testosterone values will depend on the age we are comparing to.</li>
<li>Sex: Testosterone is an average of 339.05 ng/dL higher in males than females after adjusting for age.</li>
</ul>
<p>Interestingly, we do have a similar sex difference estimated between our two models. Visually, this looks like:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod2, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod2, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>While a little better, there does appear to be an issue with assuming the the sex difference is constant across ages. We can try to account for this by including an interaction term in our next model.</p>
</section>
<section id="sex-and-age-with-natural-cubic-spline-and-their-interaction" class="level3">
<h3 class="anchored" data-anchor-id="sex-and-age-with-natural-cubic-spline-and-their-interaction">Sex and Age with Natural Cubic Spline and Their Interaction</h3>
<p>Here we will add an interaction between sex and age (with a spline) from our previous model:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR,<span class="at">df=</span><span class="dv">8</span>) <span class="sc">*</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = TESTOSTERONE ~ ns(RIDAGEYR, df = 8) * MALE, data = dat)

Residuals:
    Min      1Q  Median      3Q     Max 
-449.07  -18.74   -4.24    9.12 1580.21 

Coefficients:
                               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                      0.9041    10.8171   0.084   0.9334    
ns(RIDAGEYR, df = 8)1           37.6509    15.0955   2.494   0.0126 *  
ns(RIDAGEYR, df = 8)2           30.8584    18.5139   1.667   0.0956 .  
ns(RIDAGEYR, df = 8)3           27.0448    16.8762   1.603   0.1091    
ns(RIDAGEYR, df = 8)4           18.3903    17.1403   1.073   0.2833    
ns(RIDAGEYR, df = 8)5           21.6196    16.5372   1.307   0.1911    
ns(RIDAGEYR, df = 8)6           15.4002    14.1725   1.087   0.2772    
ns(RIDAGEYR, df = 8)7           29.5792    26.8170   1.103   0.2701    
ns(RIDAGEYR, df = 8)8           13.2040    10.6445   1.240   0.2148    
MALETRUE                        -3.9349    15.4732  -0.254   0.7993    
ns(RIDAGEYR, df = 8)1:MALETRUE 635.7286    21.3614  29.761   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)2:MALETRUE 390.8591    26.9133  14.523   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)3:MALETRUE 410.8437    24.0858  17.058   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)4:MALETRUE 386.2810    24.8818  15.525   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)5:MALETRUE 408.8234    23.5709  17.344   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)6:MALETRUE 378.7641    20.1017  18.842   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)7:MALETRUE 341.0139    38.3930   8.882   &lt;2e-16 ***
ns(RIDAGEYR, df = 8)8:MALETRUE 359.5488    15.2690  23.548   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 127.8 on 7189 degrees of freedom
  (814 observations deleted due to missingness)
Multiple R-squared:  0.705, Adjusted R-squared:  0.7044 
F-statistic:  1011 on 17 and 7189 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>While interactions can be challenging to interpret, when it is an interaction with a spline (or polynomial) we once again cannot have a simple interpretation since within each sex there is a difference in testosterone with age.</p>
<p>Visually, this looks like:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod3, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod3, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we have a great looking model! If we wanted to do a numerical check that this model is an improvement (even if hard to interpret), we could calculate something like the AIC or BIC:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">AIC</span>(mod1),<span class="fu">AIC</span>(mod2),<span class="fu">AIC</span>(mod3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 93688.00 92228.98 90387.20</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(mod1),<span class="fu">BIC</span>(mod2),<span class="fu">BIC</span>(mod3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 93715.53 92304.70 90517.97</code></pre>
</div>
</div>
<p>Both AIC and BIC agree the most complex model is an improvement over any of the simpler models.</p>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb22" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Splines in Linear Regression"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">  name: Alex Kaizer</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">  roles: "Instructor"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">  affiliation: University of Colorado-Anschutz Medical Campus</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="an">toc_float:</span><span class="co"> true</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=F, message=F, warning=F}</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>This page is part of the University of Colorado-Anschutz Medical Campus' <span class="co">[</span><span class="ot">BIOS 6618 Recitation</span><span class="co">](/recitation/index.qmd)</span> collection. To view other questions, you can view the <span class="co">[</span><span class="ot">BIOS 6618 Recitation</span><span class="co">](/recitation/index.qmd)</span> collection page or use the search bar to look for keywords.</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="fu"># Splines</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Extra Knots?</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>In our lecture slides we noted:</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>The B-spline basis is a common spline basis and can be fit in <span class="in">`R`</span> using the <span class="in">`splines::bs()`</span> function.</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>The B-spline basis is based on the knot sequence:</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>\begin{align*} </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>\xi_1 \leq \cdots &amp;  \leq \xi_d \leq \color{red}{\xi_{d+1}} &lt; \color{blue}{\xi_{d+2}} &lt; \cdots \color{blue}{\xi_{d+K+1}} <span class="sc">\\</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a> &amp; &lt; \color{red}{\xi_{d+K+2}} \leq \xi_{d+K+3} \leq \cdots \leq \xi_{2d+K+2}</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a> \end{align*}</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>The "inner knots" are represented by $\color{blue}{\xi_{d+2}} = \tau_1, \cdots, \color{blue}{\xi_{d+K+1}}=\tau_K$.</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>The "boundary knots" are defined as $\color{red}{\xi_{d+1}}=a$ and $\color{red}{\xi_{d+K+2}}=b$.</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>The choice of additional knots $\xi_1, \cdots, \xi_d$ and $\xi_{d+K+3}, \cdots, \xi_{2d+K+2}$ is somewhat arbitrary, with a common strategy being to set them equal to the boundary knots.</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>The reason we set these additional knots before and after the boundary knots (even if we set them to be identical) is to assist in defining appropriate basis functions for each segment of our data (i.e., between any two knots). This could be thought of as a mathematical trick to ensure certain properties of the B-spline are maintained, but the specific mathematical details go beyond the material for our class.</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selecting Optimal Parameters</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>In our lecture we also mentioned approaches to selecting optimal spline parameters:</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use of visual evaluation (e.g., seeing that the data does not appear to be overfit)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Model selection criterion (e.g., AIC, AICc, BIC, etc.) to compare models with different parameters (minimized AIC is preferred)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cross validation (CV) by dividing the $N$ data points into $K$ groups/folds for train/test set evaluation</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>We've seen examples of visual evaluation already, so we'll explore some approaches using model selection criteria. Let's revisit our NHANES data example focusing on modeling testosterone in males:</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'../../.data/nhanes1516_sexhormone.csv'</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>datm <span class="ot">&lt;-</span> dat[<span class="fu">which</span>(dat<span class="sc">$</span>MALE<span class="sc">==</span><span class="cn">TRUE</span>),] <span class="co"># subset to males</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>We again see a clearly non-linear trend for age and testosterone. Let's fit a range of models with different degrees of freedom (3, 4, and 5) using B-splines and natural cubic splines:</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty lists to store results in</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>bs_list <span class="ot">&lt;-</span> ns_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through degrees of freedom of 3 to 15 and save model</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( df <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">15</span> ){</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>  bs_list[[(df<span class="dv">-2</span>)]] <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">bs</span>(RIDAGEYR, <span class="at">df=</span>df), <span class="at">data=</span>datm)</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>  ns_list[[(df<span class="dv">-2</span>)]] <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR, <span class="at">df=</span>df), <span class="at">data=</span>datm)</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>Let's plot some of these trends:</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, class.source = 'fold-hide'}</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>newdatm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">80</span> )</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">1</span>))</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="co"># df=3</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=3'</span>)</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">1</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">1</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="co"># df=6</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=6'</span>)</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">4</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">4</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a><span class="co"># df=8</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=8'</span>)</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">6</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">6</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a><span class="co"># df=9</span></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>datm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>datm<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">main=</span><span class="st">'df=9'</span>)</span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(bs_list[[<span class="dv">7</span>]], <span class="at">newdata=</span>newdatm))</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span>newdatm<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span><span class="fu">predict</span>(ns_list[[<span class="dv">7</span>]], <span class="at">newdata=</span>newdatm), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'black'</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'bs'</span>,<span class="st">'ns'</span>), <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>Visually evaluating the figures, we might think df=3 looks pretty decent (expect, perhaps, at the younger ages). The fit at lower ages is improved as we increase the degrees of freedom. We also might wish to compare the B-spline and the natural cubic splines within any degree of freedom.</span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>One approach is to use model selection criteria. Let's examine a table and plot of our values for AIC and BIC:</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate AIC</span></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>aic_bs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">AIC</span>(bs_list[[x]]))</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>aic_ns <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">AIC</span>(ns_list[[x]]))</span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate BIC</span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a>bic_bs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">BIC</span>(bs_list[[x]]))</span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>bic_ns <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, <span class="cf">function</span>(x) <span class="fu">BIC</span>(ns_list[[x]]))</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a><span class="co"># table of values</span></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">cbind</span>(aic_bs,aic_ns,bic_bs,bic_ns)</span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tbl) <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>tbl <span class="co"># print</span></span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a>There is a lot going on here. To help us identify the "best" model using AIC or BIC, let's take the minimum AIC or BIC observed across both B-splines and natural cubic splines and compare:</span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> tbl <span class="sc">-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">min</span>(tbl[,<span class="fu">c</span>(<span class="st">'aic_bs'</span>,<span class="st">'aic_ns'</span>)]),<span class="fu">min</span>(tbl[,<span class="fu">c</span>(<span class="st">'bic_bs'</span>,<span class="st">'bic_ns'</span>)])), <span class="at">each=</span><span class="fu">nrow</span>(tbl)<span class="sc">*</span><span class="dv">2</span>), <span class="at">ncol=</span><span class="dv">4</span>, <span class="at">byrow=</span>F)</span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(diff,<span class="dv">1</span>)</span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a>With these results and a rule of thumb of decreases in AIC or BIC greater than 4, we notice:</span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For AIC, the natural cubic spline model with df=9 minimizes the AIC. Models within 4 of this include:</span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>df=11 B-spline ($\Delta=2.1$)</span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>df=15 B-spline ($\Delta=3.1$)</span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>df=13 natural cubic spline ($\Delta=1.4$)</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>df=14 natural cubic spline ($\Delta=2.3$)</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>However, all these models have higher degrees of freedom and are less parsimonious.</span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For BIC, the natural cubic spline model with df=9 minimizes the BIC. Models within 4 of this include:</span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>df=8 natural cubic spline ($\Delta=3.6$)</span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>Since df=8 has fewer degrees of freedom, could select it instead of df=9 because it is slightly more parsimonious</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>However, it may also be useful to visualize if there is a point where we might start to experience "diminishing returns" for increasing our model complexity (and risking overfitting the data). Here we can plot the AIC and BIC for each method and degree of freedom:</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of values</span></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>aic_bs, <span class="at">xlab=</span><span class="st">'df'</span>, <span class="at">ylab=</span><span class="st">'AIC/BIC Value'</span>, <span class="at">type=</span><span class="st">'o'</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(aic_bs,aic_ns,bic_bs,bic_ns)))</span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>aic_ns, <span class="at">pch=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>bic_bs, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">'orangered2'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">y=</span>bic_ns, <span class="at">pch=</span><span class="dv">17</span>, <span class="at">lty=</span><span class="dv">4</span>, <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">type=</span><span class="st">'o'</span>)</span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topright'</span>, <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">16</span>,<span class="dv">17</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>,<span class="st">'blue'</span>,<span class="st">'orangered2'</span>,<span class="st">'purple'</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'AIC bs'</span>,<span class="st">'AIC ns'</span>,<span class="st">'BIC bs'</span>,<span class="st">'BIC ns'</span>))</span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a>Some takeaways here:</span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Around df=7 we stop seeing larger changes (there is still some moving around, e.g., B-splines do increase from df=7 to 8 before decreasing again). So, we might consider choosing df=7 even though it wasn't "optimal" based on the change in AIC or BIC from above.</span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can see that BIC (solid points) is larger than the AIC (open points) values, where both natural cubic splines and B-splines seem to converge to very similar results at larger degrees of freedom.</span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In practice there are many ways we could justify the choice of different splines, degrees of freedom, or choice across other models.</span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Interpretation with Splines</span></span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a>We've discussed the challenges of interpreting polynomial and spline models when our primary explanatory variable of interest is the one with the nonlinear trend. Here we will explore a model with both sex and age to see how interpretations may be affected.</span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a><span class="fu">### MLR with Sex and Age</span></span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a>Let's revisit our NHANES data example focusing on modeling testosterone, but this time in males and females and plot one multiple linear regression model with sex and age:</span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'../../.data/nhanes1516_sexhormone.csv'</span>)</span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> RIDAGEYR <span class="sc">+</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod1)</span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>The interpretations of our beta coefficients here are easy to interpret:</span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Age: For a 1 year increase in age, testosterone increases by an average of 1.36 ng/dL after adjusting for sex.</span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sex: Testosterone is an average of 337.68 ng/dL higher in males than females after adjusting for age.</span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a>We can visualize, however, that this isn't likely the best fit:</span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a><span class="co"># create variable to change point type by sex</span></span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>pch <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb22-209"><a href="#cb22-209" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>pch[<span class="fu">which</span>(dat<span class="sc">$</span>MALE<span class="sc">==</span><span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb22-210"><a href="#cb22-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a>newdat_male <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">MALE=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a>newdat_female <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">RIDAGEYR=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">MALE=</span><span class="cn">FALSE</span>)</span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod1, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod1, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a>Indeed, the fits are in both groups do not appear to be accurately reflecting the trend with age. Let's try fitting a model with a natural cubic spline used for age next.</span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sex and Age with Natural Cubic Spline</span></span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-228"><a href="#cb22-228" aria-hidden="true" tabindex="-1"></a>Here we will add a natural cubic spline to age with a degree of freedom of 8 (based on our other question evaluating spline calibration):</span>
<span id="cb22-229"><a href="#cb22-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-232"><a href="#cb22-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-233"><a href="#cb22-233" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb22-234"><a href="#cb22-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-235"><a href="#cb22-235" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb22-236"><a href="#cb22-236" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR,<span class="at">df=</span><span class="dv">8</span>) <span class="sc">+</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb22-237"><a href="#cb22-237" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod2)</span>
<span id="cb22-238"><a href="#cb22-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-239"><a href="#cb22-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-240"><a href="#cb22-240" aria-hidden="true" tabindex="-1"></a>The interpretations of our sex coefficient is still easy to interpret, but age not so much:</span>
<span id="cb22-241"><a href="#cb22-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-242"><a href="#cb22-242" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Age: Given the splines, the rate of change in testosterone values will depend on the age we are comparing to.</span>
<span id="cb22-243"><a href="#cb22-243" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sex: Testosterone is an average of 339.05 ng/dL higher in males than females after adjusting for age.</span>
<span id="cb22-244"><a href="#cb22-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-245"><a href="#cb22-245" aria-hidden="true" tabindex="-1"></a>Interestingly, we do have a similar sex difference estimated between our two models. Visually, this looks like:</span>
<span id="cb22-246"><a href="#cb22-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-249"><a href="#cb22-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-250"><a href="#cb22-250" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb22-251"><a href="#cb22-251" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb22-252"><a href="#cb22-252" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-253"><a href="#cb22-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-254"><a href="#cb22-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-255"><a href="#cb22-255" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb22-256"><a href="#cb22-256" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod2, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-257"><a href="#cb22-257" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod2, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-258"><a href="#cb22-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-259"><a href="#cb22-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-260"><a href="#cb22-260" aria-hidden="true" tabindex="-1"></a>While a little better, there does appear to be an issue with assuming the the sex difference is constant across ages. We can try to account for this by including an interaction term in our next model.</span>
<span id="cb22-261"><a href="#cb22-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-262"><a href="#cb22-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-263"><a href="#cb22-263" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sex and Age with Natural Cubic Spline and Their Interaction</span></span>
<span id="cb22-264"><a href="#cb22-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-265"><a href="#cb22-265" aria-hidden="true" tabindex="-1"></a>Here we will add an interaction between sex and age (with a spline) from our previous model:</span>
<span id="cb22-266"><a href="#cb22-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-269"><a href="#cb22-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-270"><a href="#cb22-270" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb22-271"><a href="#cb22-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-272"><a href="#cb22-272" aria-hidden="true" tabindex="-1"></a><span class="co"># fit MLR</span></span>
<span id="cb22-273"><a href="#cb22-273" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">lm</span>( TESTOSTERONE <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR,<span class="at">df=</span><span class="dv">8</span>) <span class="sc">*</span> MALE, <span class="at">data=</span>dat )</span>
<span id="cb22-274"><a href="#cb22-274" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod3)</span>
<span id="cb22-275"><a href="#cb22-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-276"><a href="#cb22-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-277"><a href="#cb22-277" aria-hidden="true" tabindex="-1"></a>While interactions can be challenging to interpret, when it is an interaction with a spline (or polynomial) we once again cannot have a simple interpretation since within each sex there is a difference in testosterone with age.</span>
<span id="cb22-278"><a href="#cb22-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-279"><a href="#cb22-279" aria-hidden="true" tabindex="-1"></a>Visually, this looks like:</span>
<span id="cb22-280"><a href="#cb22-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-283"><a href="#cb22-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-284"><a href="#cb22-284" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot</span></span>
<span id="cb22-285"><a href="#cb22-285" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>dat<span class="sc">$</span>RIDAGEYR, <span class="at">y=</span>dat<span class="sc">$</span>TESTOSTERONE, <span class="at">xlab=</span><span class="st">'Age (years)'</span>, <span class="at">ylab=</span><span class="st">'Testosterone (ng/dL)'</span>, <span class="at">col=</span><span class="st">'gray85'</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">pch=</span>dat<span class="sc">$</span>pch)</span>
<span id="cb22-286"><a href="#cb22-286" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'topleft'</span>, <span class="at">bty=</span><span class="st">'n'</span>, <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">legend=</span><span class="fu">c</span>(<span class="st">'Females'</span>,<span class="st">'Males'</span>,<span class="st">'Females: Fitted Line'</span>,<span class="st">'Males: Fitted Line'</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">'gray85'</span>,<span class="st">'gray85'</span>,<span class="st">'green3'</span>,<span class="st">'purple'</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb22-287"><a href="#cb22-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-288"><a href="#cb22-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-289"><a href="#cb22-289" aria-hidden="true" tabindex="-1"></a><span class="co"># add regression fits</span></span>
<span id="cb22-290"><a href="#cb22-290" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod3, <span class="at">newdata=</span>newdat_male), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-291"><a href="#cb22-291" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">80</span>, <span class="at">y=</span><span class="fu">predict</span>(mod3, <span class="at">newdata=</span>newdat_female), <span class="at">col=</span><span class="st">'green3'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb22-292"><a href="#cb22-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-293"><a href="#cb22-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-294"><a href="#cb22-294" aria-hidden="true" tabindex="-1"></a>Here we have a great looking model! If we wanted to do a numerical check that this model is an improvement (even if hard to interpret), we could calculate something like the AIC or BIC:</span>
<span id="cb22-295"><a href="#cb22-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-298"><a href="#cb22-298" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-299"><a href="#cb22-299" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">AIC</span>(mod1),<span class="fu">AIC</span>(mod2),<span class="fu">AIC</span>(mod3))</span>
<span id="cb22-300"><a href="#cb22-300" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(mod1),<span class="fu">BIC</span>(mod2),<span class="fu">BIC</span>(mod3))</span>
<span id="cb22-301"><a href="#cb22-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-302"><a href="#cb22-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-303"><a href="#cb22-303" aria-hidden="true" tabindex="-1"></a>Both AIC and BIC agree the most complex model is an improvement over any of the simpler models.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>